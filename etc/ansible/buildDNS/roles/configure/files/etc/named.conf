#=====  FUNCTION  =============================================================
#          NAME:  named.conf
#   DESCRIPTION:  Master BIND nameserver configuration file
#
#          NOTE:  {{ ansible_managed }}
#==============================================================================

acl "localhost" {
    0.0.9.0/8;
    localhost;
};

acl "internal" {
    {{ bind_internal_acl }};
};

options {
    version                     "0.0";
    listen-on                   port 53 { {{ bind_listen_ipv4|join(';') }}; };
    hostname                    "{{ bind_host_name }};";
    directory                   "/namedb";
    dump-file                   "/var/run/cache_dump.db";
    statistics-file             "/var/run/named_stats.txt";
    memstatistics-file          "/var/run/named_mem_stats.txt";
    pid-file                    "/var/run/named.pid";
    query-source                address {{ bind_listen_ipv4 }};
    dnssec-enable               yes;
    dnssec-validation           yes;
    dnssec-lookaside            . trust-anchor dlv.isc.org;
    min-refresh-time            3600;
    max-refresh-time            86400;
    allow-transfer              { {{ bind_allow_transfer }} };
    transfer-source             {{ bind_listen_ipv4 }};
    transfers-in                100;
    transfers-per-ns            10;
    transfer-format             many-answers;
};

logging {
    channel named_log {
        file                    "/var/log/named.log" versions 3 size 5m;
        severity                error;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    channel client_log {
        file                    "/var/log/named_client.log" versions 3 size 5m;
        severity                error;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    channel txfr_log {
        file                    "/var/log/named_txfr.log" versions 3 size 5m;
        severity                error;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    channel query_log {
        file                    "/var/log/named_query.log" versions 3 size 5m;
        severity                error;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    channel security_log {
        file                    "/var/log/named_security.log" versions 3 size 5m;
        severity                error;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    channel general_log {
        file                    "/var/log/named_general.log" versions 3 size 5m;
        severity                info;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    channel dnssec_log {
        file                    "/var/log/named_dnssec.log" versions 3 size 5m;
        severity                error;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    channel update_log {
        file                    "/var/log/named_update.log" versions 3 size 5m;
        severity                error;
        print-severity          yes;
        print-time              yes;
        print-category          yes;
    };

    category general            { general_log; };
    category default            { named_log; };
    category client             { client_log; };
    category xfer-out           { txfr_log; };
    category xfer-in            { txfr_log; };
    category queries            { query_log; };
    category security           { security_log; };
    category dnssec             { dnssec_log; };
    category update             { update_log; };
    category update-security    { update_log; };
};

controls {
    inet * port 10953 allow { "localhost"; } keys { rndc-key; };
};

# include security keys
include                         "/etc/dnssec-keys/rndc.key";
include                         "/etc/dnssec-keys/transfer.conf";

// include root keys
include                         "/etc/dnssec-keys/dlv.isc.org.conf";
include                         "/etc/dnssec-keys/bg.conf";
include                         "/etc/dnssec-keys/br.conf";
include                         "/etc/dnssec-keys/cz.conf";
include                         "/etc/dnssec-keys/gov.conf";
include                         "/etc/dnssec-keys/museum.conf";
include                         "/etc/dnssec-keys/org.conf";
include                         "/etc/dnssec-keys/pr.conf";
include                         "/etc/dnssec-keys/se.conf";

view "localhost" {
    match-clients               { "localhost"; };
    recursion                   yes;
    forwarders                  { 8.8.4.4; 208.67.222.222; 8.8.8.8; 208.67.220.220; };
    allow-new-zones             yes;

    zone "." IN {
        type                    hint;
        file                    "/namedb/root.servers";
    };

    zone "localhost" in {
        type                    master;
        file                    "master/named.local";
        allow-update            { none; };
        allow-transfer          { none; };
    };

    zone "0.0.127.in-addr.arpa" in {
        type                    master;
        file                    "master/0.0.127.in-addr.arpa";
        allow-update            { none; };
        allow-transfer          { none; };
    };
};

view "internal" {
    match-clients               { "internal"; };
    recursion                   yes;
    forwarders                  { 8.8.4.4; 208.67.222.222; 8.8.8.8; 208.67.220.220; };

    zone "." in {
        type                    hint;
        file                    "/namedb/root.servers";
    };
};

view "public" {
    match-clients               { any; };
    recursion                   no;
};
